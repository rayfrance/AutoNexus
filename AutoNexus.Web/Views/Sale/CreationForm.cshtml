@model AutoNexus.Web.Models.SaleFormViewModel

@{
    ViewData["Title"] = "Nova Venda";
    Layout = "~/Pages/Shared/_Layout.cshtml";
}

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

<div class="container mt-4 pb-5 mb-5">
    <div class="d-flex justify-content-between align-items-center">
        <h2>Registrar Nova Venda</h2>
        <span class="badge bg-success text-white">Vendas Abertas</span>
    </div>
    <hr />

    <div class="row">
        <div class="col-md-8">
            <form asp-action="Create" id="createSaleForm">
                <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                <h5 class="text-secondary mb-3"><i class="bi bi-car-front"></i> Dados do Veículo</h5>

                <div class="mb-3">
                    <label asp-for="VehicleId" class="form-label fw-bold">Selecione o Veículo</label>
                    <select asp-for="VehicleId" class="form-select select2" id="ddlVehicle">
                        <option value="">-- Buscar Veículo Disponível --</option>
                        @if (Model.AvailableVehicles != null)
                        {
                            foreach (var car in Model.AvailableVehicles)
                            {
                                // O atributo data-price guarda o preço original para validação visual no JS
                                <option value="@car.Id" data-price="@car.Price">
                                    @car.Manufacturer?.Name @car.Model (@car.Year) - Tabela: R$ @car.Price.ToString("N2")
                                </option>
                            }
                        }
                    </select>
                    <span asp-validation-for="VehicleId" class="text-danger"></span>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label asp-for="SaleDate" class="form-label fw-bold">Data da Venda</label>
                        <input asp-for="SaleDate" class="form-control" type="date" />
                        <span asp-validation-for="SaleDate" class="text-danger"></span>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label asp-for="SalePrice" class="form-label fw-bold">Preço Final (R$)</label>
                        <input asp-for="SalePrice" class="form-control" type="text" placeholder="0,00" id="txtSalePrice" />
                        <span asp-validation-for="SalePrice" class="text-danger"></span>
                        <div class="form-text text-muted" id="priceHelpText">
                            Selecione um veículo para ver o teto de preço.
                        </div>
                    </div>
                </div>

                <hr class="my-4" />

                <h5 class="text-secondary mb-3"><i class="bi bi-person-vcard"></i> Dados do Cliente</h5>

                <div class="mb-3">
                    <label asp-for="ClientName" class="form-label fw-bold">Nome Completo</label>
                    <input asp-for="ClientName" class="form-control" placeholder="Ex: João da Silva" />
                    <span asp-validation-for="ClientName" class="text-danger"></span>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label asp-for="ClientCPF" class="form-label fw-bold">CPF</label>
                        <input asp-for="ClientCPF" class="form-control" placeholder="000.000.000-00" />
                        <span asp-validation-for="ClientCPF" class="text-danger"></span>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label asp-for="ClientPhone" class="form-label fw-bold">Telefone</label>
                        <input asp-for="ClientPhone" class="form-control" placeholder="(00) 00000-0000" />
                        <span asp-validation-for="ClientPhone" class="text-danger"></span>
                    </div>
                </div>

                <div class="mt-4">
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="bi bi-check-lg"></i> Finalizar Venda
                    </button>
                    <a asp-controller="Vehicle" asp-action="Index" class="btn btn-secondary btn-lg">Voltar</a>
                </div>
            </form>
        </div>

        <div class="col-md-4 d-none d-md-block">
            <div class="alert alert-info">
                <h5><i class="bi bi-info-circle"></i> Processo de Venda</h5>
                <p class="small">
                    1. <strong>Selecione o Veículo:</strong> A lista exibe apenas carros com status "Disponível".<br>
                    2. <strong>Verifique o Preço:</strong> O valor da venda não pode ultrapassar a tabela do veículo.<br>
                    3. <strong>Dados do Cliente:</strong> O CPF é validado para garantir unicidade no cadastro.<br>
                    <br>
                    Ao finalizar, o veículo sairá automaticamente do estoque e um <strong>Protocolo Único</strong> será gerado.
                </p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        $(document).ready(function() {
            // Inicializa Select2 
            $('.select2').select2({
                theme: 'bootstrap-5',
                width: '100%',
                placeholder: "-- Selecione um Veículo --",
                allowClear: true
            });

            // Elementos
            const $ddlVehicle = $('#ddlVehicle');
            const $helpText = $('#priceHelpText');

            //  Atualizar Dica de Preço ao selecionar carro
            $ddlVehicle.on('change', function() {
                // Pega a opção selecionada usando jQuery
                const $selectedOption = $(this).find('option:selected');
                const maxPrice = $selectedOption.data('price'); 

                if (maxPrice) {
                    // Formata para BRL
                    const formatted = parseFloat(maxPrice.toString().replace(',', '.')).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

                    $helpText.html(`<i class="bi bi-tag-fill"></i> Tabela Máxima: <strong class="text-success">${formatted}</strong>`);
                } else {
                    $helpText.text('Selecione um veículo para ver o teto de preço.');
                }
            });
        });
    </script>
}